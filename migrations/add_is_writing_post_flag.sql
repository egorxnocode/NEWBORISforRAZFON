-- ============================================================
-- Добавление флага is_writing_post для блокировки кнопок
-- ============================================================

-- Добавляем колонку для отслеживания процесса написания поста через AI
ALTER TABLE users ADD COLUMN IF NOT EXISTS is_writing_post BOOLEAN DEFAULT FALSE;

-- Добавляем комментарий
COMMENT ON COLUMN users.is_writing_post IS 'TRUE если пользователь в процессе написания поста через AI-генератор. Блокирует кнопку "Сдать задание" до завершения.';

-- Проверяем результат
SELECT 
    COUNT(*) as total_users,
    COUNT(CASE WHEN is_writing_post = TRUE THEN 1 END) as currently_writing_post,
    COUNT(CASE WHEN is_writing_post = FALSE OR is_writing_post IS NULL THEN 1 END) as not_writing_post
FROM users;

-- Ожидаемый результат:
-- total_users | currently_writing_post | not_writing_post
--     150     |           0            |       150
-- 
-- Все существующие пользователи получат is_writing_post = FALSE
-- Это НЕ влияет на их course_state, current_task, penalties и другие данные

-- ============================================================
-- ПРИМЕЧАНИЯ:
-- ============================================================
-- 
-- Когда флаг устанавливается в TRUE:
-- - Пользователь нажал кнопку "Напиши пост"
-- - Начался диалог с AI-генератором
-- - Кнопка "Сдать задание" блокируется
--
-- Когда флаг сбрасывается в FALSE:
-- - Пост успешно сгенерирован и принят
-- - Пользователь отменил генерацию (если будет команда /cancel)
-- - Прошло более 15 минут с начала генерации (автосброс)
--
-- Безопасность:
-- - Операция мгновенная (миллисекунды)
-- - НЕ блокирует базу данных
-- - НЕ влияет на активных пользователей
-- - Все существующие пользователи получают FALSE (безопасное значение)
