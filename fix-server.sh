#!/bin/bash

# ============================================================
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
# ============================================================

set -e

echo "ðŸ”§ Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð• ÐŸÐ ÐžÐ‘Ð›Ð•Ðœ Ð‘ÐžÐ¢Ð"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

cd /opt/NEWBORISforRAZFON

# 1. ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
echo "1ï¸âƒ£ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°..."
docker stop telegram-bot 2>/dev/null || echo "ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ ÑƒÐ¶Ðµ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
docker rm telegram-bot 2>/dev/null || echo "ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ ÑƒÐ´Ð°Ð»ÐµÐ½"
echo "âœ… ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
echo ""

# 2. ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº ÑÐµÑ‚ÑÐ¼
echo "2ï¸âƒ£ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker ÑÐµÑ‚ÐµÐ¹..."
if docker network inspect supabase_default >/dev/null 2>&1; then
    echo "âœ… Ð¡ÐµÑ‚ÑŒ supabase_default Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
else
    echo "âŒ Ð¡ÐµÑ‚ÑŒ supabase_default Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°!"
    echo "Ð¡Ð¿Ð¸ÑÐ¾Ðº ÑÐµÑ‚ÐµÐ¹:"
    docker network ls
    exit 1
fi

if docker network inspect n8n_default >/dev/null 2>&1; then
    echo "âœ… Ð¡ÐµÑ‚ÑŒ n8n_default Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
else
    echo "âŒ Ð¡ÐµÑ‚ÑŒ n8n_default Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°!"
    exit 1
fi
echo ""

# 3. ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ .env
echo "3ï¸âƒ£ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°..."
if [ -f ".env" ]; then
    # Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ URL Supabase (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ð¹ Ð¿Ð¾Ñ€Ñ‚ 8000)
    sed -i 's|SUPABASE_URL=http://supabase:8009|SUPABASE_URL=http://supabase-kong:8000|g' .env
    sed -i 's|SUPABASE_URL=http://supabase:8000|SUPABASE_URL=http://supabase-kong:8000|g' .env
    
    echo "âœ… .env Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½"
    echo ""
    echo "Ð¢ÐµÐºÑƒÑ‰Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸:"
    grep -E "SUPABASE_URL|N8N_WEBHOOK_URL" .env
else
    echo "âŒ .env Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
    exit 1
fi
echo ""

# 4. ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ requirements.txt
echo "4ï¸âƒ£ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ requirements.txt (Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ð° Ð²ÐµÑ€ÑÐ¸Ð¹)..."
cat > requirements.txt << 'EOF'
aiogram==3.3.0
python-dotenv==1.0.0
supabase==2.9.1
httpx==0.27.2
aiohttp==3.9.1
validators==0.22.0
apscheduler==3.10.4
pytz==2023.3
openai==1.6.1
pydub==0.25.1
EOF
echo "âœ… requirements.txt Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½"
echo ""

# 5. ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ docker-compose
echo "5ï¸âƒ£ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ docker-compose Ð´Ð»Ñ Ð´Ð²ÑƒÑ… ÑÐµÑ‚ÐµÐ¹..."
cat > docker-compose.fixed.yml << 'EOF'
version: '3.8'

services:
  telegram-bot:
    build: .
    container_name: telegram-bot
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./media:/app/media
      - ./audio_temp:/app/audio_temp
      - ./logs:/app/logs
    ports:
      - "8080:8080"
    networks:
      - n8n_default
      - supabase_default
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  n8n_default:
    external: true
  supabase_default:
    external: true
EOF
echo "âœ… docker-compose.fixed.yml ÑÐ¾Ð·Ð´Ð°Ð½"
echo ""

# 6. ÐŸÐµÑ€ÐµÑÐ±Ð¾Ñ€ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº
echo "6ï¸âƒ£ ÐŸÐµÑ€ÐµÑÐ±Ð¾Ñ€ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°..."
docker-compose -f docker-compose.fixed.yml build --no-cache
docker-compose -f docker-compose.fixed.yml up -d
echo "âœ… ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
echo ""

# 7. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°
echo "7ï¸âƒ£ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾Ð³Ð¾Ð² (10 ÑÐµÐºÑƒÐ½Ð´)..."
sleep 10
docker logs --tail=30 telegram-bot
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð• Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐž!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÑ‚ÐµÐ¹:"
docker inspect telegram-bot --format='Ð¡ÐµÑ‚Ð¸: {{range $k,$v := .NetworkSettings.Networks}}{{$k}} {{end}}'
echo ""
echo "ðŸ“ Ð”Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð»Ð¾Ð³Ð¾Ð²:"
echo "   docker logs -f telegram-bot"

